<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Final Boss Health</title>
  <style>
    :root{
      --bg:#1a1a1a; --fg:#fff;
      --bar-bg:#444; --bar:#d90429; --bar-border:#000;
      --mana:#2d7cf6; --mana-glow:rgba(45,124,246,.35);
      --radius-pill:9999px; --space-2:12px; --space-3:16px; --space-4:24px;
      --shadow:0 0 15px rgba(0,0,0,.5);
      --table-bg:#202020; --table-row:#1e1e1e; --muted:#cfcfcf;
    }

    /* Page */
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      display:flex; align-items:center; justify-content:center; min-height:100svh; padding:var(--space-4);
    }

    /* Two-column layout */
    .layout{
      display:flex;
      width:100%;
      max-width:1200px;
      gap:var(--space-4);
      align-items:center; /* vertically center left to right column’s height */
    }
    .column-left{
      flex:0 0 30%;
      max-width:30%;
      display:flex; flex-direction:column;
    }
    .column-right{ flex:1 1 0; min-width:0; padding:10px; }

    /* Boss (left) */
    .boss-container{ display:flex; flex-direction:column; gap:var(--space-3); text-align:center; }
    h1{ margin:0; text-transform:uppercase; letter-spacing:.08em; font-weight:800; font-size:clamp(1.25rem, 5vw, 2rem); }

    .boss-portrait{
      width:100%; max-width:240px; margin:0 auto; aspect-ratio:1/1; border-radius:50%; overflow:hidden;
      box-shadow:var(--shadow); border:3px solid #000; background:#222;
    }
    .boss-portrait img{ width:100%; height:100%; object-fit:cover; object-position:25% 50%; display:block; }

    .hp-wrap{ display:flex; flex-direction:column; gap:var(--space-2); align-items:stretch; }
    .hp-bar-background{
      display:flex; align-items:center; width:100%;
      background:var(--bar-bg); border:3px solid var(--bar-border);
      border-radius:var(--radius-pill); padding:6px; box-shadow:var(--shadow);
      min-height:clamp(28px, 6vw, 56px);
    }
    .hp-bar-foreground{
      height:clamp(18px, 5vw, 44px);
      background:var(--bar); border-radius:var(--radius-pill);
      width:100%; transition:width 1.5s ease-out;
    }
    .hp-text{ margin:0; font-weight:800; line-height:1.2; font-size:clamp(.95rem, 4.5vw, 1.25rem); text-shadow:0 1px 0 rgba(0,0,0,.3); }

    /* Card base */
    .card{
      background:var(--table-bg);
      border:1px solid #111;
      border-radius:16px;
      padding:16px;
      box-shadow:var(--shadow);
    }

    /* Leaderboard (right) */
    .leaderboard h2{ margin:0 0 8px 0; font-size:clamp(1.1rem, 3.5vw, 1.4rem); }
    .lb-note{ margin:0 0 12px 0; color:var(--muted); font-size:.95rem; }

    .lb-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px; /* “cards” rows */
    }
    .lb-th, .lb-td{
      padding:10px 12px;
      text-align:left;
      font-size:.95rem;
    }
    .lb-th{
      color:#ddd; font-weight:700; text-transform:uppercase; letter-spacing:.06em;
      font-size:.8rem;
    }
    .lb-row{
      background:var(--table-row);
      border-radius:12px;
    }
    .lb-row .lb-td:first-child{ border-top-left-radius:12px; border-bottom-left-radius:12px; }
    .lb-row .lb-td:last-child{ border-top-right-radius:12px; border-bottom-right-radius:12px; }

    /* Mana bar */
    .mana-wrap{ display:flex; flex-direction:column; gap:6px; }
    .mana-bar-bg{
      display:flex; align-items:center;
      width:100%;
      background:#2a2a2a;
      border:2px solid #0b1a33;
      border-radius:var(--radius-pill);
      padding:4px;
      box-shadow:0 0 0 2px #0b1a33 inset, 0 0 16px var(--mana-glow);
      min-height:22px;
    }
    .mana-bar-fg{
      height:14px;
      background:linear-gradient(180deg, var(--mana), #1c5fd9);
      border-radius:var(--radius-pill);
      width:0%;
      transition:width .9s ease-in-out;
    }
    .mana-text{
      font-size:.9rem; font-weight:700; color:#e7f0ff;
      text-shadow:0 1px 0 rgba(0,0,0,.4);
    }

    /* Damage history table */
    .history{ margin-top:16px; }
    .history h3{ margin:0 0 8px 0; font-size:clamp(1rem, 3.5vw, 1.2rem); }
    .hist-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 6px;
    }
    .hist-row{ background:var(--table-row); border-radius:12px; }
    .hist-td{ padding:10px 12px; font-size:.95rem; }
    .hist-row .hist-td:first-child{ border-radius:12px; }

    .damage-num {
      color: #ff4d4d;   /* bright red */
      font-weight: 700;
    }

    /* Narrow screens */
    @media (max-width:520px){
      .layout{ flex-wrap:wrap; }
      .column-left{ flex:1 1 100%; max-width:100%; }
      .column-right{ flex:1 1 100%; }
      .lb-th:nth-child(3), .lb-td:nth-child(3){ display:none; }
    }

    @media (prefers-reduced-motion: reduce){
      .hp-bar-foreground, .mana-bar-fg{ transition:none; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- LEFT (30%) -->
    <div class="column-left">
      <div class="boss-container">
        <h1>Final Boss</h1>
        <div class="boss-portrait">
          <img id="bossImage" src="assets/img/boss-1.png" alt="Boss portrait" />
        </div>
        <div class="hp-wrap">
          <div class="hp-bar-background" aria-label="Health bar">
            <div class="hp-bar-foreground" id="healthBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100"></div>
          </div>
          <p class="hp-text" id="healthText">Loading...</p>
        </div>
      </div>
    </div>

    <!-- RIGHT (70%) -->
    <div class="column-right">
      <!-- Leaderboard -->
      <div class="leaderboard card">
        <h2>Skor Leaderboard</h2>
        <p class="lb-note">Diurutkan berdasarkan "total damage" (tertinggi terlebih dahulu)</p>
        <table class="lb-table" aria-describedby="Leaderboard sorted by total damage">
          <thead>
            <tr>
              <th class="lb-th">Grup</th>
              <th class="lb-th">Mana</th>
              <th class="lb-th">Total Damage</th>
              <th class="lb-th">Jumlah Games</th>
            </tr>
          </thead>
          <tbody id="lbBody"></tbody>
        </table>
      </div>

      <!-- Damage History -->
      <div class="history card">
        <h3>Histori Damage (5 Terakhir)</h3>
        <table class="hist-table" aria-describedby="Latest damage dealt events">
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ===== Endpoints ===== */
    const UPDATE_HEALTH_SCRIPT_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE";
    const LEADERBOARD_SCRIPT_URL   = "YOUR_LEADERBOARD_APPS_SCRIPT_URL_HERE";
    const DAMAGE_HISTORY_SCRIPT_URL= "YOUR_DAMAGE_HISTORY_APPS_SCRIPT_URL_HERE";

    /* ===== Assets ===== */
    const IMG_FULL  = "assets/img/boss-1.png";
    const IMG_HALF  = "assets/img/boss-2.png";
    const IMG_QUART = "assets/img/boss-3.png";

    /* ===== DOM ===== */
    const healthBar  = document.getElementById('healthBar');
    const healthText = document.getElementById('healthText');
    const bossImage  = document.getElementById('bossImage');
    const lbBody     = document.getElementById('lbBody');
    const histBody   = document.getElementById('histBody');

    /* ===== Boss health + portrait ===== */
    function setBossImageByHP(percent){
      if (percent < 25) bossImage.src = IMG_QUART;
      else if (percent < 50) bossImage.src = IMG_HALF;
      else bossImage.src = IMG_FULL;
    }

    async function updateHealth() {
      try {
        const res = await fetch(UPDATE_HEALTH_SCRIPT_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Health API not ok");
        const data = await res.json();

        const currentHP = Math.max(0, Number(data.currentHP));
        const maxHP     = Math.max(1, Number(data.maxHP));
        const pct       = Math.max(0, Math.min(100, (currentHP / maxHP) * 100));

        healthBar.style.width = pct + '%';
        healthBar.setAttribute('aria-valuenow', Math.round(pct));
        healthText.textContent = `${currentHP.toLocaleString()} / ${maxHP.toLocaleString()} HP`;

        setBossImageByHP(pct);
      } catch (e) {
        console.error(e);
        healthText.textContent = "Error fetching data.";
      }
    }

    /* ===== Leaderboard ===== */
    function renderLeaderboard(groups){
      groups.sort((a,b) => (b.totalDamage||0) - (a.totalDamage||0));
      lbBody.innerHTML = "";
      for (const g of groups){
        const tr = document.createElement('tr'); tr.className = "lb-row";

        const nameTd = td("lb-td", g.name || "—");
        const manaTd = document.createElement('td'); manaTd.className = "lb-td";
        manaTd.appendChild(buildManaBar(g.manaCurrent, g.manaMax));
        const dmgTd  = td("lb-td", (g.totalDamage ?? 0).toLocaleString());
        const games  = `${g.gamesPlayed ?? 0} / ${g.gamesTotal ?? 0}`;
        const gamesTd= td("lb-td", games);

        tr.append(nameTd, manaTd, dmgTd, gamesTd);
        lbBody.appendChild(tr);
      }
    }

    function buildManaBar(current=0, max=1){
      current = Math.max(0, Number(current));
      max     = Math.max(1, Number(max));
      const pct = Math.max(0, Math.min(100, (current/max)*100));

      const wrap = div("mana-wrap");
      const barBg = div("mana-bar-bg", { role:"progressbar", "aria-valuemin":"0", "aria-valuemax":"100", "aria-valuenow":String(Math.round(pct)) });
      const barFg = div("mana-bar-fg"); barFg.style.width = pct + '%';
      const text  = div("mana-text"); text.textContent = `${current.toLocaleString()} / ${max.toLocaleString()} MP`;

      barBg.appendChild(barFg);
      wrap.append(barBg, text);
      return wrap;
    }

    async function updateLeaderboard(){
      try{
        const res = await fetch(LEADERBOARD_SCRIPT_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Leaderboard API not ok");
        const data = await res.json();
        renderLeaderboard(Array.isArray(data) ? data : (data.groups || []));
        // If your leaderboard endpoint already returns history under `history`, render it too:
        if (data && data.history) renderDamageHistory(data.history);
      }catch(e){
        console.error(e);
        renderLeaderboard([
          { name:"Jaya Bersama",       manaCurrent:120, manaMax:200, totalDamage:5300, gamesPlayed:2, gamesTotal:6 },
          { name:"Hidup Bersama",      manaCurrent:  0, manaMax:100, totalDamage:3950, gamesPlayed:6, gamesTotal:6 },
          { name:"Tenang Bersama",     manaCurrent: 30, manaMax:100, totalDamage:3250, gamesPlayed:5, gamesTotal:6 },
          { name:"Sukacita Bersama",   manaCurrent: 80, manaMax:150, totalDamage:4700, gamesPlayed:1, gamesTotal:6 },
          { name:"Sadar Bersama",      manaCurrent: 10, manaMax:100, totalDamage:2500, gamesPlayed:4, gamesTotal:6 }
        ]);
      }
    }

    /* ===== Damage History ===== */
    // Expected item shape: { team: "Name", damage: 123, timestamp: "2025-08-25T10:15:00Z" }
    function renderDamageHistory(history, getXNumberOfRecords){
      if (!Array.isArray(history)) return;
      // Sort newest first, then take 10
      history.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
      const topRecords = history.slice(0,getXNumberOfRecords);

      histBody.innerHTML = "";
      for (const item of topRecords){
        const tr = document.createElement('tr'); tr.className = "hist-row";
        const tdMsg = document.createElement('td'); tdMsg.className = "hist-td";
        const team = document.createElement('strong'); team.textContent = item.team || "—";
        const dmg  = document.createElement('strong');
        dmg.className = "damage-num";
        dmg.textContent  = (item.damage ?? 0).toLocaleString();

        tdMsg.append(team, document.createTextNode(" ⚔️ "), dmg, document.createTextNode(" damage terhadap Boss"));
        tr.appendChild(tdMsg);
        histBody.appendChild(tr);
      }
    }

    async function updateHistory(){
      const noOfRecords = 5;

      try{
        const res = await fetch(DAMAGE_HISTORY_SCRIPT_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("History API not ok");
        const data = await res.json();
        renderDamageHistory(Array.isArray(data) ? data : (data.history || []), noOfRecords);
      }catch(e){
        console.error(e);
        // Fallback demo data (newest first after sort)
        renderDamageHistory([
          { team:"Hidup Bersama",    damage: 450, timestamp: "2025-08-25T11:18:00Z" },
          { team:"Tenang Bersama",   damage: 320, timestamp: "2025-08-25T11:16:00Z" },
          { team:"Jaya Bersama",     damage: 900, timestamp: "2025-08-25T11:10:00Z" },
          { team:"Sukacita Bersama", damage: 120, timestamp: "2025-08-25T11:09:30Z" },
          { team:"Sadar Bersama",    damage: 210, timestamp: "2025-08-25T11:06:00Z" },
        ], noOfRecords);
      }
    }

    /* ===== Helpers ===== */
    function td(cls, text){ const el=document.createElement('td'); el.className=cls; el.textContent=text; return el; }
    function div(cls, attrs){ const el=document.createElement('div'); el.className=cls; if(attrs){ for(const k in attrs){ el.setAttribute(k, attrs[k]); } } return el; }

    /* ===== Kickoff + intervals ===== */
    const HIT_API_EVERY_MIN = 20;
    const INTERVAL_MS = HIT_API_EVERY_MIN * 60 * 1000; // fixed: multiply by 1000

    updateHealth();
    updateLeaderboard();
    updateHistory();

    // Polling
    setInterval(updateHealth, INTERVAL_MS);
    setInterval(updateLeaderboard, INTERVAL_MS);
    setInterval(updateHistory, INTERVAL_MS);
  </script>
</body>
</html>
