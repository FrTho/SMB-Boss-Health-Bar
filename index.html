<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Final Boss Health</title>
  <style>
    :root{
      --bg:#1a1a1a; --fg:#fff;
      --bar-bg:#444; --bar:#d90429; --bar-border:#000;
      --mana:#2d7cf6;               /* mana color */
      --mana-glow:rgba(45,124,246,.35);
      --radius-pill:9999px; --space-2:12px; --space-3:16px; --space-4:24px;
      --shadow:0 0 15px rgba(0,0,0,.5);
      --table-bg:#202020; --table-row:#1e1e1e; --muted:#cfcfcf;
    }

    /* Page */
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      display:flex; align-items:center; justify-content:center; min-height:100svh; padding:var(--space-4);
    }

    /* Two-column layout */
    .layout{
      display:flex;
      width:100%;
      max-width:1200px;
      gap:var(--space-4);
    }
    .column-left{
      flex:0 0 30%;
      max-width:30%;
      display:flex; flex-direction:column;
    }
    .column-right{ flex:1 1 0; min-width:0; padding: 10px; }

    /* Boss (left) */
    .boss-container{ display:flex; flex-direction:column; gap:var(--space-3); text-align:center; }
    h1{ margin:0; text-transform:uppercase; letter-spacing:.08em; font-weight:800; font-size:clamp(1.25rem, 5vw, 2rem); }

    .boss-portrait{
      width:100%; max-width:240px; margin:0 auto; aspect-ratio:1/1; border-radius:50%; overflow:hidden;
      box-shadow:var(--shadow); border:3px solid #000; background:#222;
    }
    .boss-portrait img{ width:100%; height:100%; object-fit:cover; object-position:25% 50%; display:block; }

    .hp-wrap{ display:flex; flex-direction:column; gap:var(--space-2); align-items:stretch; }
    .hp-bar-background{
      display:flex; align-items:center; width:100%;
      background:var(--bar-bg); border:3px solid var(--bar-border);
      border-radius:var(--radius-pill); padding:6px; box-shadow:var(--shadow);
      min-height:clamp(28px, 6vw, 56px);
    }
    .hp-bar-foreground{
      height:clamp(18px, 5vw, 44px);
      background:var(--bar); border-radius:var(--radius-pill);
      width:100%; transition:width 1.5s ease-out;
    }
    .hp-text{ margin:0; font-weight:800; line-height:1.2; font-size:clamp(.95rem, 4.5vw, 1.25rem); text-shadow:0 1px 0 rgba(0,0,0,.3); }

    /* Leaderboard (right) */
    .leaderboard{
      background:var(--table-bg);
      border:1px solid #111;
      border-radius:16px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .leaderboard h2{ margin:0 0 8px 0; font-size:clamp(1.1rem, 3.5vw, 1.4rem); }
    .lb-note{ margin:0 0 12px 0; color:var(--muted); font-size:.95rem; }

    .lb-table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px; /* “cards” rows */
    }
    .lb-th, .lb-td{
      padding:10px 12px;
      text-align:left;
      font-size:.95rem;
    }
    .lb-th{
      color:#ddd; font-weight:700; text-transform:uppercase; letter-spacing:.06em;
      font-size:.8rem;
    }
    .lb-row{
      background:var(--table-row);
      border-radius:12px;
    }
    /* Make each “row” look like a card with rounded corners */
    .lb-row .lb-td:first-child{ border-top-left-radius:12px; border-bottom-left-radius:12px; }
    .lb-row .lb-td:last-child{ border-top-right-radius:12px; border-bottom-right-radius:12px; }

    /* Mana bar (similar to HP bar but blue) */
    .mana-wrap{ display:flex; flex-direction:column; gap:6px; }
    .mana-bar-bg{
      display:flex; align-items:center;
      width:100%;
      background:#2a2a2a;
      border:2px solid #0b1a33;
      border-radius:var(--radius-pill);
      padding:4px;
      box-shadow:0 0 0 2px #0b1a33 inset, 0 0 16px var(--mana-glow);
      min-height:22px;
    }
    .mana-bar-fg{
      height:14px;
      background:linear-gradient(180deg, var(--mana), #1c5fd9);
      border-radius:var(--radius-pill);
      width:0%;
      transition:width .9s ease-in-out;
    }
    .mana-text{
      font-size:.9rem; font-weight:700; color:#e7f0ff;
      text-shadow:0 1px 0 rgba(0,0,0,.4);
    }

    /* Narrow screens: stack columns */
    @media (max-width:520px){
      .layout{ flex-wrap:wrap; }
      .column-left{ flex:1 1 100%; max-width:100%; }
      .column-right{ flex:1 1 100%; }
      .lb-th:nth-child(3), .lb-td:nth-child(3){ display:none; } /* hide Total Damage label column header on very small screens to save space; value remains in column 2 text */
    }

    @media (prefers-reduced-motion: reduce){
      .hp-bar-foreground, .mana-bar-fg{ transition:none; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- LEFT (30%) -->
    <div class="column-left">
      <div class="boss-container">
        <h1>Final Boss</h1>

        <!-- Circle-cropped portrait -->
        <div class="boss-portrait">
          <img id="bossImage" src="assets/img/boss-1.png" alt="Boss portrait" />
        </div>

        <div class="hp-wrap">
          <div class="hp-bar-background" aria-label="Health bar">
            <div class="hp-bar-foreground" id="healthBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100"></div>
          </div>
          <p class="hp-text" id="healthText">Loading...</p>
        </div>
      </div>
    </div>

    <!-- RIGHT (70%) -->
    <div class="column-right">
      <div class="leaderboard">
        <h2>Skor Leaderboard</h2>
        <p class="lb-note">Diurutkan berdasarkan "total damage" (tertinggi terlebih dahulu)</p>

        <table class="lb-table" aria-describedby="Leaderboard sorted by total damage">
          <thead>
            <tr>
              <th class="lb-th">Grup</th>
              <th class="lb-th">Mana</th>
              <th class="lb-th">Total Damage</th>
              <th class="lb-th">Games Played</th>
            </tr>
          </thead>
          <tbody id="lbBody">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ===== Endpoints ===== */
    const UPDATE_HEALTH_SCRIPT_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE";
    const LEADERBOARD_SCRIPT_URL   = "YOUR_LEADERBOARD_APPS_SCRIPT_URL_HERE";

    /* ===== Assets ===== */
    const IMG_FULL  = "assets/img/boss-1.png"; // 50–100% (and 100%)
    const IMG_HALF  = "assets/img/boss-2.png"; // < 50%
    const IMG_QUART = "assets/img/boss-3.png"; // < 25%

    /* ===== DOM ===== */
    const healthBar  = document.getElementById('healthBar');
    const healthText = document.getElementById('healthText');
    const bossImage  = document.getElementById('bossImage');
    const lbBody     = document.getElementById('lbBody');

    /* ===== Boss health + portrait ===== */
    function setBossImageByHP(percent){
      if (percent < 25) bossImage.src = IMG_QUART;
      else if (percent < 50) bossImage.src = IMG_HALF;
      else bossImage.src = IMG_FULL;
    }

    async function updateHealth() {
      try {
        const res = await fetch(UPDATE_HEALTH_SCRIPT_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Health API not ok");
        const data = await res.json();

        const currentHP = Math.max(0, Number(data.currentHP));
        const maxHP     = Math.max(1, Number(data.maxHP));
        const pct       = Math.max(0, Math.min(100, (currentHP / maxHP) * 100));

        healthBar.style.width = pct + '%';
        healthBar.setAttribute('aria-valuenow', Math.round(pct));
        healthText.textContent = `${currentHP.toLocaleString()} / ${maxHP.toLocaleString()} HP`;

        setBossImageByHP(pct);
      } catch (e) {
        console.error(e);
        healthText.textContent = "Error fetching data.";
      }
    }

    /* ===== Leaderboard ===== */
    function renderLeaderboard(groups){
      // sort by totalDamage desc
      groups.sort((a,b) => (b.totalDamage||0) - (a.totalDamage||0));

      // clear
      lbBody.innerHTML = "";

      for (const g of groups){
        const tr = document.createElement('tr');
        tr.className = "lb-row";

        const nameTd = document.createElement('td');
        nameTd.className = "lb-td";
        nameTd.textContent = g.name || "—";

        const manaTd = document.createElement('td');
        manaTd.className = "lb-td";
        manaTd.appendChild(buildManaBar(g.manaCurrent, g.manaMax));

        const dmgTd = document.createElement('td');
        dmgTd.className = "lb-td";
        dmgTd.textContent = (g.totalDamage ?? 0).toLocaleString();

        const gamesTd = document.createElement('td');
        gamesTd.className = "lb-td";
        const played = g.gamesPlayed ?? 0;
        const total  = g.gamesTotal  ?? 0;
        gamesTd.textContent = `${played} / ${total}`;

        tr.append(nameTd, manaTd, dmgTd, gamesTd);
        lbBody.appendChild(tr);
      }
    }

    function buildManaBar(current=0, max=1){
      current = Math.max(0, Number(current));
      max     = Math.max(1, Number(max));
      const pct = Math.max(0, Math.min(100, (current/max)*100));

      const wrap = document.createElement('div');
      wrap.className = "mana-wrap";

      const barBg = document.createElement('div');
      barBg.className = "mana-bar-bg";
      barBg.setAttribute('role','progressbar');
      barBg.setAttribute('aria-valuemin','0');
      barBg.setAttribute('aria-valuemax','100');
      barBg.setAttribute('aria-valuenow', String(Math.round(pct)));

      const barFg = document.createElement('div');
      barFg.className = "mana-bar-fg";
      barFg.style.width = pct + '%';

      const text = document.createElement('div');
      text.className = "mana-text";
      text.textContent = `${current.toLocaleString()} / ${max.toLocaleString()} MP`;

      barBg.appendChild(barFg);
      wrap.append(barBg, text);
      return wrap;
    }

    async function updateLeaderboard(){
      try{
        const res = await fetch(LEADERBOARD_SCRIPT_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Leaderboard API not ok");
        const data = await res.json();
        // Expect an array of groups
        renderLeaderboard(Array.isArray(data) ? data : (data.groups || []));
      }catch(e){
        console.error(e);
        // Fallback sample so UI still renders
        renderLeaderboard([
          { name:"Jaya Bersama",  manaCurrent:120, manaMax:200, totalDamage:5300, gamesPlayed:2, gamesTotal:6 },
          { name:"Sukacita Bersama",  manaCurrent: 80, manaMax:150, totalDamage:4700, gamesPlayed:1, gamesTotal:6 },
          { name:"Sadar Bersama", manaCurrent: 60, manaMax:100, totalDamage:2950, gamesPlayed:1, gamesTotal:6 }
        ]);
      }
    }

    /* ===== Kickoff + intervals ===== */
    const HIT_API_EVERY_X_MIN = 20;
    const HIT_API_EVERY_SEC = HIT_API_EVERY_X_MIN * 60;
    const HIT_API_EVERY_MIL_SEC = HIT_API_EVERY_SEC * 100;

    // asuumptions:
    // - 7 devices
    // - 5 games
    // - run for 3 hours (180 mins)
    //
    // 7 devices x 5 games = 35 requests
    // (180 / 20) * 35 = 315 requests
    updateHealth();
    setInterval(updateHealth, HIT_API_EVERY_MIL_SEC);

    updateLeaderboard();
    // Update leaderboard every 30s (tweak as needed)
    setInterval(updateLeaderboard, HIT_API_EVERY_MIL_SEC);
  </script>
</body>
</html>
